{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Voltex/Downloads/OOAD%20Project/OOAD%20Project/lib/db.ts"],"sourcesContent":["import { createClient, SupabaseClient } from '@supabase/supabase-js';\n\nconst SUPABASE_URL = process.env.SUPABASE_URL;\nconst SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_KEY;\n\nif (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {\n  // Do not throw here to allow the app to run in environments where DB isn't configured yet,\n  // but many routes will fail until env is provided.\n  console.warn('SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY is not set. Supabase client will not be initialized.');\n}\n\nexport const supabaseAdmin: SupabaseClient | null =\n  SUPABASE_URL && SUPABASE_SERVICE_ROLE_KEY\n    ? createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, { auth: { persistSession: false } })\n    : null;\n\nexport async function getUserByEmail(email: string) {\n  if (!supabaseAdmin) throw new Error('Supabase client not initialized');\n  const { data, error } = await supabaseAdmin.from('users').select('id, email, password_hash, name, role').eq('email', email).limit(1).maybeSingle();\n  if (error) throw error;\n  return data as any | null;\n}\n\nexport async function createUser({ name, email, passwordHash, role = 'student' }: { name: string; email: string; passwordHash: string; role?: string; }) {\n  if (!supabaseAdmin) throw new Error('Supabase client not initialized');\n  const { data, error } = await supabaseAdmin.from('users').insert({ name, email, password_hash: passwordHash, role }).select('id, email, role').maybeSingle();\n  if (error) throw error;\n  return data;\n}\n\nexport async function getUserById(id: string) {\n  if (!supabaseAdmin) throw new Error('Supabase client not initialized');\n  const { data, error } = await supabaseAdmin.from('users').select('id, name, email, role').eq('id', id).limit(1).maybeSingle();\n  if (error) throw error;\n  return data;\n}\n\n// Optional: small helper to run raw SQL if needed via RPC or other means. For now we rely on standard CRUD methods.\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;AAEA,MAAM,eAAe,QAAQ,GAAG,CAAC,YAAY;AAC7C,MAAM,4BAA4B,QAAQ,GAAG,CAAC,yBAAyB,IAAI,QAAQ,GAAG,CAAC,YAAY;AAEnG,IAAI,CAAC,gBAAgB,CAAC,2BAA2B;IAC/C,2FAA2F;IAC3F,mDAAmD;IACnD,QAAQ,IAAI,CAAC;AACf;AAEO,MAAM,gBACX,gBAAgB,4BACZ,IAAA,0NAAY,EAAC,cAAc,2BAA2B;IAAE,MAAM;QAAE,gBAAgB;IAAM;AAAE,KACxF;AAEC,eAAe,eAAe,KAAa;IAChD,IAAI,CAAC,eAAe,MAAM,IAAI,MAAM;IACpC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,cAAc,IAAI,CAAC,SAAS,MAAM,CAAC,wCAAwC,EAAE,CAAC,SAAS,OAAO,KAAK,CAAC,GAAG,WAAW;IAChJ,IAAI,OAAO,MAAM;IACjB,OAAO;AACT;AAEO,eAAe,WAAW,EAAE,IAAI,EAAE,KAAK,EAAE,YAAY,EAAE,OAAO,SAAS,EAAyE;IACrJ,IAAI,CAAC,eAAe,MAAM,IAAI,MAAM;IACpC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,cAAc,IAAI,CAAC,SAAS,MAAM,CAAC;QAAE;QAAM;QAAO,eAAe;QAAc;IAAK,GAAG,MAAM,CAAC,mBAAmB,WAAW;IAC1J,IAAI,OAAO,MAAM;IACjB,OAAO;AACT;AAEO,eAAe,YAAY,EAAU;IAC1C,IAAI,CAAC,eAAe,MAAM,IAAI,MAAM;IACpC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,cAAc,IAAI,CAAC,SAAS,MAAM,CAAC,yBAAyB,EAAE,CAAC,MAAM,IAAI,KAAK,CAAC,GAAG,WAAW;IAC3H,IAAI,OAAO,MAAM;IACjB,OAAO;AACT,EAEA,oHAAoH"}},
    {"offset": {"line": 97, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Voltex/Downloads/OOAD%20Project/OOAD%20Project/lib/auth.ts"],"sourcesContent":["import { jwtVerify, SignJWT } from 'jose';\nimport { cookies } from 'next/headers';\n\nconst JWT_SECRET = new TextEncoder().encode(process.env.JWT_SECRET || 'your-secret-key-change-in-production');\n\nexport async function createToken(userId: string, email: string, role: string) {\n  const token = await new SignJWT({ userId, email, role })\n    .setProtectedHeader({ alg: 'HS256' })\n    .setExpirationTime('7d')\n    .sign(JWT_SECRET);\n  \n  return token;\n}\n\nexport async function verifyToken(token: string) {\n  try {\n    const verified = await jwtVerify(token, JWT_SECRET);\n    return verified.payload as { userId: string; email: string; role: string };\n  } catch (error) {\n    return null;\n  }\n}\n\nexport async function setAuthCookie(token: string) {\n  const cookieStore = await cookies();\n  cookieStore.set('auth-token', token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: 7 * 24 * 60 * 60,\n  });\n}\n\nexport async function getAuthToken() {\n  try {\n    const cookieStore = await cookies();\n    const token = cookieStore.get('auth-token')?.value;\n    console.log('getAuthToken - found token:', token ? 'yes' : 'no');\n    return token;\n  } catch (err) {\n    console.log('getAuthToken - cookies() error:', err);\n    return null;\n  }\n}\n\nexport async function getCurrentUser() {\n  try {\n    const token = await getAuthToken();\n    console.log('getCurrentUser - token from cookie:', token ? 'yes' : 'no');\n    if (!token) return null;\n    const verified = await verifyToken(token);\n    console.log('getCurrentUser - verified:', verified ? 'yes' : 'no');\n    return verified;\n  } catch (err) {\n    console.log('getCurrentUser - error:', err);\n    return null;\n  }\n}\n\nexport async function clearAuthCookie() {\n  const cookieStore = await cookies();\n  cookieStore.delete('auth-token');\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;AAAA;AACA;;;AAEA,MAAM,aAAa,IAAI,cAAc,MAAM,CAAC,QAAQ,GAAG,CAAC,UAAU,IAAI;AAE/D,eAAe,YAAY,MAAc,EAAE,KAAa,EAAE,IAAY;IAC3E,MAAM,QAAQ,MAAM,IAAI,mLAAO,CAAC;QAAE;QAAQ;QAAO;IAAK,GACnD,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,iBAAiB,CAAC,MAClB,IAAI,CAAC;IAER,OAAO;AACT;AAEO,eAAe,YAAY,KAAa;IAC7C,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,uLAAS,EAAC,OAAO;QACxC,OAAO,SAAS,OAAO;IACzB,EAAE,OAAO,OAAO;QACd,OAAO;IACT;AACF;AAEO,eAAe,cAAc,KAAa;IAC/C,MAAM,cAAc,MAAM,IAAA,6JAAO;IACjC,YAAY,GAAG,CAAC,cAAc,OAAO;QACnC,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,QAAQ,IAAI,KAAK,KAAK;IACxB;AACF;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,cAAc,MAAM,IAAA,6JAAO;QACjC,MAAM,QAAQ,YAAY,GAAG,CAAC,eAAe;QAC7C,QAAQ,GAAG,CAAC,+BAA+B,QAAQ,QAAQ;QAC3D,OAAO;IACT,EAAE,OAAO,KAAK;QACZ,QAAQ,GAAG,CAAC,mCAAmC;QAC/C,OAAO;IACT;AACF;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,QAAQ,MAAM;QACpB,QAAQ,GAAG,CAAC,uCAAuC,QAAQ,QAAQ;QACnE,IAAI,CAAC,OAAO,OAAO;QACnB,MAAM,WAAW,MAAM,YAAY;QACnC,QAAQ,GAAG,CAAC,8BAA8B,WAAW,QAAQ;QAC7D,OAAO;IACT,EAAE,OAAO,KAAK;QACZ,QAAQ,GAAG,CAAC,2BAA2B;QACvC,OAAO;IACT;AACF;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,6JAAO;IACjC,YAAY,MAAM,CAAC;AACrB"}},
    {"offset": {"line": 176, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Voltex/Downloads/OOAD%20Project/OOAD%20Project/app/api/auth/sync/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { supabaseAdmin } from '@/lib/db';\r\nimport { createToken, setAuthCookie } from '@/lib/auth';\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const { access_token } = await request.json();\r\n    if (!access_token) return NextResponse.json({ success: false, error: 'access_token required' }, { status: 400 });\r\n\r\n    let user: any = null;\r\n\r\n    // Prefer using the admin client if it's configured with a service role key\r\n    const hasServiceRole = !!process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n    if (supabaseAdmin && hasServiceRole) {\r\n      const { data, error } = await supabaseAdmin.auth.getUser(access_token as string);\r\n      if (error || !data?.user) {\r\n        console.error('supabase admin getUser error:', error);\r\n        return NextResponse.json({ success: false, error: 'Invalid access token (admin)' }, { status: 401 });\r\n      }\r\n      user = data.user;\r\n    } else {\r\n      // Fallback: call the Supabase auth REST endpoint with the access token to get the user\r\n      // This works even when we don't have a service_role key because the access token authenticates as the user\r\n      const SUPABASE_URL = process.env.SUPABASE_URL;\r\n      const SUPABASE_KEY = process.env.SUPABASE_KEY;\r\n      try {\r\n        const resp = await fetch(`${SUPABASE_URL}/auth/v1/user`, {\r\n          headers: {\r\n            Authorization: `Bearer ${access_token}`,\r\n            apikey: SUPABASE_KEY || '',\r\n            'Content-Type': 'application/json',\r\n          },\r\n        });\r\n        if (!resp.ok) {\r\n          const txt = await resp.text().catch(() => '');\r\n          console.error('supabase REST get user failed', resp.status, txt);\r\n          return NextResponse.json({ success: false, error: 'Invalid access token (rest)' }, { status: 401 });\r\n        }\r\n        user = await resp.json();\r\n      } catch (restErr) {\r\n        console.error('supabase REST get user error:', restErr);\r\n        return NextResponse.json({ success: false, error: 'Invalid access token (rest-error)' }, { status: 401 });\r\n      }\r\n    }\r\n  const role = (user.user_metadata as any)?.role || (user.user_metadata?.role) || 'student';\r\n\r\n    // Create our app JWT and set cookie\r\n    let cookieSet = false;\r\n    try {\r\n      const token = await createToken(user.id, user.email || '', role);\r\n      await setAuthCookie(token);\r\n      cookieSet = true;\r\n    } catch (cookieErr) {\r\n      console.error('setAuthCookie error:', cookieErr);\r\n    }\r\n\r\n    return NextResponse.json({ success: true, data: { userId: user.id, email: user.email, role }, cookieSet });\r\n  } catch (err: any) {\r\n    console.error('auth/sync error:', err);\r\n    return NextResponse.json({ success: false, error: err?.message || 'Sync failed' }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,MAAM,QAAQ,IAAI;QAC3C,IAAI,CAAC,cAAc,OAAO,iKAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;QAE9G,IAAI,OAAY;QAEhB,2EAA2E;QAC3E,MAAM,iBAAiB,CAAC,CAAC,QAAQ,GAAG,CAAC,yBAAyB;QAC9D,IAAI,6IAAa,IAAI,gBAAgB;YACnC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,6IAAa,CAAC,IAAI,CAAC,OAAO,CAAC;YACzD,IAAI,SAAS,CAAC,MAAM,MAAM;gBACxB,QAAQ,KAAK,CAAC,iCAAiC;gBAC/C,OAAO,iKAAY,CAAC,IAAI,CAAC;oBAAE,SAAS;oBAAO,OAAO;gBAA+B,GAAG;oBAAE,QAAQ;gBAAI;YACpG;YACA,OAAO,KAAK,IAAI;QAClB,OAAO;YACL,uFAAuF;YACvF,2GAA2G;YAC3G,MAAM,eAAe,QAAQ,GAAG,CAAC,YAAY;YAC7C,MAAM,eAAe,QAAQ,GAAG,CAAC,YAAY;YAC7C,IAAI;gBACF,MAAM,OAAO,MAAM,MAAM,GAAG,aAAa,aAAa,CAAC,EAAE;oBACvD,SAAS;wBACP,eAAe,CAAC,OAAO,EAAE,cAAc;wBACvC,QAAQ,gBAAgB;wBACxB,gBAAgB;oBAClB;gBACF;gBACA,IAAI,CAAC,KAAK,EAAE,EAAE;oBACZ,MAAM,MAAM,MAAM,KAAK,IAAI,GAAG,KAAK,CAAC,IAAM;oBAC1C,QAAQ,KAAK,CAAC,iCAAiC,KAAK,MAAM,EAAE;oBAC5D,OAAO,iKAAY,CAAC,IAAI,CAAC;wBAAE,SAAS;wBAAO,OAAO;oBAA8B,GAAG;wBAAE,QAAQ;oBAAI;gBACnG;gBACA,OAAO,MAAM,KAAK,IAAI;YACxB,EAAE,OAAO,SAAS;gBAChB,QAAQ,KAAK,CAAC,iCAAiC;gBAC/C,OAAO,iKAAY,CAAC,IAAI,CAAC;oBAAE,SAAS;oBAAO,OAAO;gBAAoC,GAAG;oBAAE,QAAQ;gBAAI;YACzG;QACF;QACF,MAAM,OAAO,AAAC,KAAK,aAAa,EAAU,QAAS,KAAK,aAAa,EAAE,QAAS;QAE9E,oCAAoC;QACpC,IAAI,YAAY;QAChB,IAAI;YACF,MAAM,QAAQ,MAAM,IAAA,6IAAW,EAAC,KAAK,EAAE,EAAE,KAAK,KAAK,IAAI,IAAI;YAC3D,MAAM,IAAA,+IAAa,EAAC;YACpB,YAAY;QACd,EAAE,OAAO,WAAW;YAClB,QAAQ,KAAK,CAAC,wBAAwB;QACxC;QAEA,OAAO,iKAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,MAAM;gBAAE,QAAQ,KAAK,EAAE;gBAAE,OAAO,KAAK,KAAK;gBAAE;YAAK;YAAG;QAAU;IAC1G,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,oBAAoB;QAClC,OAAO,iKAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO,KAAK,WAAW;QAAc,GAAG;YAAE,QAAQ;QAAI;IACnG;AACF"}}]
}